<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ver Lista de Compras - Bargainly Shopping</title>
    <link rel="icon" type="image/svg+xml" href="../../favicon.svg" />
    <link rel="stylesheet" href="../../static/css/style.css" />
    <link rel="stylesheet" href="../../static/css/view-shopping-list.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Header Navigation -->
    <header class="header-nav">
      <div class="nav-content">
        <a href="shopping-lists.html" class="back-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
          </svg>
          Voltar √†s Listas
        </a>

        <div class="header-actions">
          <button class="header-btn" id="shareBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"
              />
            </svg>
            Compartilhar
          </button>
          <button class="header-btn" id="printBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"
              />
            </svg>
            Imprimir
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
      <!-- Loading State -->
      <div class="loading" id="loadingState">Carregando lista...</div>

      <!-- List Content -->
      <div id="listContent" style="display: none">
        <!-- List Header -->
        <section class="list-header fade-in">
          <h1 class="list-title" id="listTitle">Lista de Compras</h1>

          <div class="list-meta">
            <div class="meta-item market" id="listMarket">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M7 4V2C7 1.45 7.45 1 8 1H16C16.55 1 17 1.45 17 2V4H20C20.55 4 21 4.45 21 5S20.55 6 20 6H19V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V6H4C3.45 6 3 5.55 3 5S3.45 4 4 4H7Z"
                />
              </svg>
              Mercado n√£o informado
            </div>
            <div class="meta-item date" id="listDate">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.89-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.11-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"
                />
              </svg>
              <span id="dateText">Data</span>
            </div>
            <div class="meta-item code" id="shareCode" onclick="copyShareCode()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"
                />
              </svg>
              C√≥digo: <span id="codeText">0000</span>
            </div>
          </div>

          <div class="list-stats">
            <div class="stat-item">
              <span class="stat-value" id="totalItems">0</span>
              <span class="stat-label">Itens</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="checkedItems">0</span>
              <span class="stat-label">Marcados</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="totalCategories">0</span>
              <span class="stat-label">Categorias</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="totalValue">R$ 0,00</span>
              <span class="stat-label">Total</span>
            </div>
          </div>
        </section>

        <!-- Categories -->
        <div class="categories-container" id="categoriesContainer">
          <!-- Categories will be populated here -->
        </div>

        <!-- Actions -->
        <section class="list-actions">
          <div class="actions-grid">
            <button class="action-btn" onclick="showAddItemForm()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
              </svg>
              Adicionar Item
            </button>
            <button class="action-btn" onclick="markAllComplete()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
                />
              </svg>
              Marcar Todos
            </button>
            <button class="action-btn secondary" onclick="clearAllChecks()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11H7v-2h10v2z"
                />
              </svg>
              Desmarcar Todos
            </button>
            <a href="create-shopping-list.html" class="action-btn secondary">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
              </svg>
              Nova Lista
            </a>
            <a href="shopping-lists.html" class="action-btn secondary">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 0 0-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.1.89 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.11-.9-2-2-2z"
                />
              </svg>
              Minhas Listas
            </a>
          </div>
        </section>

        <!-- Add Item Form -->
        <section class="add-item-form" id="addItemForm" style="display: none">
          <div class="form-header">
            <h3>Adicionar Novo Item</h3>
            <button class="close-form-btn" onclick="hideAddItemForm()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                />
              </svg>
            </button>
          </div>
          <form id="newItemForm">
            <div class="form-grid">
              <div class="input-group">
                <label for="itemName">Nome do Produto *</label>
                <input type="text" id="itemName" name="product_name" required maxlength="100" />
              </div>
              <div class="input-group">
                <label for="itemCategory">Categoria *</label>
                <select id="itemCategory" name="category" required>
                  <option value="">Selecione uma categoria</option>
                  <option value="A√ßougue">ü•© A√ßougue</option>
                  <option value="Padaria">üçû Padaria</option>
                  <option value="Latic√≠nios">ü•õ Latic√≠nios</option>
                  <option value="Bebidas">ü•§ Bebidas</option>
                  <option value="Cereais e Gr√£os">üåæ Cereais e Gr√£os</option>
                  <option value="Frutas">üçé Frutas</option>
                  <option value="Verduras e Legumes">ü•¨ Verduras e Legumes</option>
                  <option value="Congelados">‚ùÑÔ∏è Congelados</option>
                  <option value="Higiene">üßº Higiene</option>
                  <option value="Limpeza">üßΩ Limpeza</option>
                  <option value="Mercearia">üè™ Mercearia</option>
                  <option value="Doces e Sobremesas">üç∞ Doces e Sobremesas</option>
                  <option value="Outros">üì¶ Outros</option>
                </select>
              </div>
              <div class="input-group">
                <label for="itemQuantity">Quantidade *</label>
                <input
                  type="number"
                  id="itemQuantity"
                  name="quantity"
                  required
                  min="0.01"
                  step="0.01"
                  value="1"
                />
              </div>
              <div class="input-group">
                <label for="itemUnit">Unidade *</label>
                <select id="itemUnit" name="unit" required>
                  <option value="un">un (unidade)</option>
                  <option value="kg">kg (quilograma)</option>
                  <option value="g">g (grama)</option>
                  <option value="l">l (litro)</option>
                  <option value="ml">ml (mililitro)</option>
                  <option value="cx">cx (caixa)</option>
                  <option value="pct">pct (pacote)</option>
                </select>
              </div>
              <div class="input-group">
                <label for="itemPrice">Pre√ßo Unit√°rio</label>
                <input
                  type="number"
                  id="itemPrice"
                  name="unit_price"
                  min="0"
                  step="0.01"
                  placeholder="0.00"
                />
              </div>
              <div class="input-group full-width">
                <label for="itemNotes">Observa√ß√µes</label>
                <textarea
                  id="itemNotes"
                  name="notes"
                  maxlength="200"
                  placeholder="Observa√ß√µes opcionais..."
                ></textarea>
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="action-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                </svg>
                Adicionar Item
              </button>
              <button type="button" class="action-btn secondary" onclick="hideAddItemForm()">
                Cancelar
              </button>
            </div>
          </form>
        </section>
      </div>

      <!-- Error State -->
      <div class="empty-state" id="errorState" style="display: none">
        <div class="empty-icon">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"
            />
          </svg>
        </div>
        <h3 class="empty-title">Lista n√£o encontrada</h3>
        <p>A lista que voc√™ est√° procurando n√£o existe ou foi removida.</p>
        <a href="shopping-lists.html" class="action-btn action-link"> Voltar √†s Listas </a>
      </div>
    </main>

    <script>
      // Utility function to escape HTML
      function escapeHtml(text) {
        if (typeof text !== 'string') return text;
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Global variables
      let currentList = null;
      let listItems = [];

      // Get user ID from localStorage (matching utils.js pattern)
      async function getUserId() {
        // Try to get from localStorage directly
        const userData = localStorage.getItem('bargainly_user');
        if (userData) {
          const user = JSON.parse(userData);
          if (user.user_id) {
            return user.user_id;
          }
        }

        console.error('Usu√°rio n√£o autenticado (user_id n√£o encontrado)');
        throw new Error('Usu√°rio n√£o autenticado');
      }

      // Initialize app
      document.addEventListener('DOMContentLoaded', function () {
        loadList();
        setupEventListeners();

        // Setup new item form
        document.getElementById('newItemForm').addEventListener('submit', async function (e) {
          e.preventDefault();
          await addNewItem();
        });
      });

      // Setup event listeners
      function setupEventListeners() {
        document.getElementById('shareBtn').addEventListener('click', shareList);
        document.getElementById('printBtn').addEventListener('click', printList);
      }

      // Load list from URL parameters
      function loadList() {
        const urlParams = new URLSearchParams(window.location.search);
        const listId = urlParams.get('id');
        const shareCode = urlParams.get('code');

        if (listId) {
          loadListById(listId);
        } else if (shareCode) {
          loadListByCode(shareCode);
        } else {
          showError();
        }
      }

      // Load list by ID
      async function loadListById(id) {
        try {
          // Get user ID for authorization
          const user_id = await getUserId();

          // Call API to get shopping list by ID
          const response = await fetch(
            `/.netlify/functions/get-shopping-list?id=${encodeURIComponent(id)}&user_id=${encodeURIComponent(user_id)}`,
            {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }
          );

          if (response.status === 404) {
            showError();
            return;
          }

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Erro ao carregar lista');
          }

          const list = await response.json();

          // Transform data to match expected format
          const transformedList = {
            id: list.id,
            title: list.title,
            description: list.description || '',
            market: list.market_name || 'Mercado n√£o informado',
            date: list.shopping_date,
            shareCode: list.share_code,
            items: list.items
              ? list.items.map((item) => ({
                  id: item.id,
                  name: item.product_name,
                  category: item.category,
                  quantity: item.quantity,
                  unit: item.unit,
                  price: item.unit_price,
                  checked: item.is_checked || false,
                }))
              : [],
          };

          displayList(transformedList);
        } catch (error) {
          console.error('Error loading list:', error);
          showError();
        }
      }

      // Load list by share code
      async function loadListByCode(code) {
        try {
          // Call API to get shopping list by share code
          const response = await fetch(
            `/.netlify/functions/get-shopping-list-by-code?code=${encodeURIComponent(code)}`,
            {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            }
          );

          if (response.status === 404) {
            showError();
            return;
          }

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Erro ao carregar lista');
          }

          const foundList = await response.json();

          if (!foundList) {
            showError();
            return;
          }

          // Transform data to match expected format
          const transformedList = {
            id: foundList.id,
            title: foundList.title,
            description: foundList.description || '',
            market: foundList.market_name || 'Mercado n√£o informado',
            date: foundList.shopping_date,
            shareCode: foundList.share_code,
            items: foundList.items
              ? foundList.items.map((item) => ({
                  id: item.id,
                  name: item.product_name,
                  category: item.category,
                  quantity: item.quantity,
                  unit: item.unit,
                  price: item.unit_price,
                  checked: item.is_checked || false,
                }))
              : [],
          };

          displayList(transformedList);
        } catch (error) {
          console.error('Error loading list by code:', error);
          showError();
        }
      }

      // Display list
      function displayList(list) {
        currentList = list;
        listItems = list.items;

        // Hide loading, show content
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('listContent').style.display = 'block';

        // Update header
        document.getElementById('listTitle').textContent = list.title;
        document.getElementById('listMarket').innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M7 4V2C7 1.45 7.45 1 8 1H16C16.55 1 17 1.45 17 2V4H20C20.55 4 21 4.45 21 5S20.55 6 20 6H19V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V6H4C3.45 6 3 5.55 3 5S3.45 4 4 4H7Z"/>
                </svg>
                ${list.market || 'Mercado n√£o informado'}
            `;
        document.getElementById('dateText').textContent = formatDate(list.date);
        document.getElementById('codeText').textContent = list.shareCode;

        // Group items by category and sort by price
        const groupedItems = groupItemsByCategory(list.items);
        displayCategories(groupedItems);
        updateStats();
      }

      // Group items by category
      function groupItemsByCategory(items) {
        const grouped = {};

        items.forEach((item) => {
          if (!grouped[item.category]) {
            grouped[item.category] = [];
          }
          grouped[item.category].push({
            ...item,
            total: item.quantity * item.price,
          });
        });

        // Sort items within each category by price (cheapest first)
        Object.keys(grouped).forEach((category) => {
          grouped[category].sort((a, b) => a.price - b.price);
        });

        return grouped;
      }

      // Display categories
      function displayCategories(groupedItems) {
        const container = document.getElementById('categoriesContainer');
        container.innerHTML = '';

        Object.keys(groupedItems).forEach((category, index) => {
          const items = groupedItems[category];
          const categoryTotal = items.reduce((sum, item) => sum + item.total, 0);

          const categorySection = document.createElement('div');
          categorySection.className = 'category-section slide-in';
          categorySection.style.animationDelay = `${index * 0.1}s`;

          categorySection.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">
                            <div class="category-icon">${getCategoryIcon(category)}</div>
                            ${category}
                            <span class="item-price">
                                (${items.length} ${items.length === 1 ? 'item' : 'itens'})
                            </span>
                        </div>
                        <div class="category-total">
                            <div class="category-total-value">R$ ${categoryTotal.toFixed(2)}</div>
                            <div class="category-total-label">Total da categoria</div>
                        </div>
                    </div>
                    <div class="category-items">
                        ${items.map((item, itemIndex) => createItemHTML(item, itemIndex, items.length)).join('')}
                    </div>
                `;

          container.appendChild(categorySection);
        });
      }

      // Create item HTML
      function createItemHTML(item, index, totalInCategory) {
        let priceRank = '';
        if (totalInCategory > 1) {
          if (index === 0) {
            priceRank = '<span class="price-rank cheapest">MAIS BARATO</span>';
          } else if (index === totalInCategory - 1) {
            priceRank = '<span class="price-rank most-expensive">MAIS CARO</span>';
          } else if (totalInCategory > 2) {
            priceRank = '<span class="price-rank expensive">INTERMEDI√ÅRIO</span>';
          }
        }

        return `
                <div class="item-row ${item.checked ? 'checked' : ''}" onclick="toggleItem('${item.id}')">
                    <input type="checkbox" class="item-checkbox" ${item.checked ? 'checked' : ''} 
                           onchange="toggleItem('${item.id}')" onclick="event.stopPropagation()">
                    <div class="item-name">
                        ${escapeHtml(item.name)}
                        ${priceRank}
                    </div>
                    <div class="item-quantity">${item.quantity} ${item.unit}</div>
                    <div class="item-price">R$ ${item.price.toFixed(2)}</div>
                    <div class="item-total">R$ ${(item.quantity * item.price).toFixed(2)}</div>
                    <div class="item-actions">
                        <button class="item-action-btn delete" onclick="confirmDeleteItem('${item.id}'); event.stopPropagation();" title="Remover item">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
      }

      // Toggle item checked state
      async function toggleItem(itemId) {
        const item = listItems.find((i) => i.id === itemId);
        if (item) {
          const newCheckedState = !item.checked;

          try {
            // Update on server
            const response = await fetch(
              `/.netlify/functions/update-shopping-list-item?itemId=${itemId}`,
              {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  is_checked: newCheckedState,
                }),
              }
            );

            if (!response.ok) {
              throw new Error('Erro ao atualizar item');
            }

            // Update local state
            item.checked = newCheckedState;

            // Update display
            const groupedItems = groupItemsByCategory(listItems);
            displayCategories(groupedItems);
            updateStats();

            showNotification(
              newCheckedState ? 'Item marcado como comprado' : 'Item desmarcado',
              'success'
            );
          } catch (error) {
            console.error('Error updating item:', error);
            showNotification('Erro ao atualizar item: ' + error.message, 'error');
          }
        }
      }

      // Show add item form
      function showAddItemForm() {
        document.getElementById('addItemForm').style.display = 'block';
        document.getElementById('itemName').focus();
      }

      // Hide add item form
      function hideAddItemForm() {
        document.getElementById('addItemForm').style.display = 'none';
        document.getElementById('newItemForm').reset();
      }

      // Handle new item form submission
      async function addNewItem() {
        if (!currentList) {
          showNotification('Lista n√£o encontrada', 'error');
          return;
        }

        const form = document.getElementById('newItemForm');
        const formData = new FormData(form);

        const itemData = {
          product_name: formData.get('product_name').trim(),
          category: formData.get('category'),
          quantity: parseFloat(formData.get('quantity')),
          unit: formData.get('unit'),
          unit_price: formData.get('unit_price') ? parseFloat(formData.get('unit_price')) : 0,
          notes: formData.get('notes')?.trim() || null,
        };

        // Basic validation
        if (!itemData.product_name || !itemData.category || !itemData.quantity || !itemData.unit) {
          showNotification('Preencha todos os campos obrigat√≥rios', 'error');
          return;
        }

        if (itemData.quantity <= 0) {
          showNotification('Quantidade deve ser maior que zero', 'error');
          return;
        }

        try {
          // Add loading state
          const submitBtn = form.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.innerHTML = '<span>Adicionando...</span>';
          submitBtn.disabled = true;

          // Call API to add item
          const response = await fetch(
            `/.netlify/functions/add-shopping-list-item?listId=${currentList.id}`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(itemData),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Erro ao adicionar item');
          }

          const newItem = await response.json();

          // Transform data to match expected format
          const transformedItem = {
            id: newItem.id,
            name: newItem.product_name,
            category: newItem.category,
            quantity: newItem.quantity,
            unit: newItem.unit,
            price: newItem.unit_price,
            checked: newItem.is_checked || false,
          };

          // Add to local state
          listItems.push(transformedItem);

          // Update display
          const groupedItems = groupItemsByCategory(listItems);
          displayCategories(groupedItems);
          updateStats();

          // Reset form and hide
          hideAddItemForm();
          showNotification('Item adicionado com sucesso!', 'success');
        } catch (error) {
          console.error('Error adding item:', error);
          showNotification('Erro ao adicionar item: ' + error.message, 'error');
        } finally {
          // Restore button state
          const submitBtn = form.querySelector('button[type="submit"]');
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }

      // Confirm delete item
      function confirmDeleteItem(itemId) {
        const item = listItems.find((i) => i.id === itemId);
        if (item && confirm(`Tem certeza que deseja remover "${item.name}" da lista?`)) {
          deleteItem(itemId);
        }
      }

      // Delete item from list
      async function deleteItem(itemId) {
        try {
          // Call API to remove item
          const response = await fetch(
            `/.netlify/functions/remove-shopping-list-item?itemId=${itemId}`,
            {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json',
              },
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Erro ao remover item');
          }

          // Remove from local state
          const itemIndex = listItems.findIndex((item) => item.id === itemId);
          if (itemIndex > -1) {
            const removedItem = listItems.splice(itemIndex, 1)[0];

            // Update display
            const groupedItems = groupItemsByCategory(listItems);
            displayCategories(groupedItems);
            updateStats();

            showNotification(`"${removedItem.name}" removido da lista`, 'success');
          }
        } catch (error) {
          console.error('Error deleting item:', error);
          showNotification('Erro ao remover item: ' + error.message, 'error');
        }
      }

      // Update statistics
      function updateStats() {
        const totalItems = listItems.length;
        const checkedItems = listItems.filter((item) => item.checked).length;
        const totalCategories = new Set(listItems.map((item) => item.category)).size;
        const totalValue = listItems.reduce((sum, item) => sum + item.quantity * item.price, 0);

        document.getElementById('totalItems').textContent = totalItems;
        document.getElementById('checkedItems').textContent = checkedItems;
        document.getElementById('totalCategories').textContent = totalCategories;
        document.getElementById('totalValue').textContent = `R$ ${totalValue.toFixed(2)}`;
      }

      // Mark all items as complete
      async function markAllComplete() {
        try {
          // Update all items on server
          const updatePromises = listItems.map((item) =>
            fetch(`/.netlify/functions/update-shopping-list-item?itemId=${item.id}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                is_checked: true,
              }),
            })
          );

          const responses = await Promise.all(updatePromises);
          
          // Check if all requests succeeded
          const allSucceeded = responses.every((response) => response.ok);
          
          if (!allSucceeded) {
            throw new Error('Erro ao atualizar alguns itens');
          }

          // Update local state
          listItems.forEach((item) => (item.checked = true));
          
          // Update display
          const groupedItems = groupItemsByCategory(listItems);
          displayCategories(groupedItems);
          updateStats();
          
          showNotification('Todos os itens marcados como comprados', 'success');
        } catch (error) {
          console.error('Error marking all items:', error);
          showNotification('Erro ao marcar todos os itens: ' + error.message, 'error');
        }
      }

      // Clear all checks
      async function clearAllChecks() {
        try {
          // Update all items on server
          const updatePromises = listItems.map((item) =>
            fetch(`/.netlify/functions/update-shopping-list-item?itemId=${item.id}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                is_checked: false,
              }),
            })
          );

          const responses = await Promise.all(updatePromises);
          
          // Check if all requests succeeded
          const allSucceeded = responses.every((response) => response.ok);
          
          if (!allSucceeded) {
            throw new Error('Erro ao atualizar alguns itens');
          }

          // Update local state
          listItems.forEach((item) => (item.checked = false));
          
          // Update display
          const groupedItems = groupItemsByCategory(listItems);
          displayCategories(groupedItems);
          updateStats();
          
          showNotification('Todos os itens desmarcados', 'success');
        } catch (error) {
          console.error('Error clearing all items:', error);
          showNotification('Erro ao desmarcar todos os itens: ' + error.message, 'error');
        }
      }

      // Share list
      function shareList() {
        if (currentList) {
          const shareData = {
            title: `Lista de Compras: ${currentList.title}`,
            text: `Acesse minha lista de compras com o c√≥digo: ${currentList.shareCode}`,
            url: window.location.href,
          };

          if (navigator.share) {
            navigator.share(shareData);
          } else {
            // Fallback to clipboard
            navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`).then(() => {
              showNotification('Link copiado para a √°rea de transfer√™ncia!', 'success');
            });
          }
        }
      }

      // Copy share code
      function copyShareCode() {
        if (currentList) {
          navigator.clipboard.writeText(currentList.shareCode).then(() => {
            showNotification(`C√≥digo ${currentList.shareCode} copiado!`, 'success');
          });
        }
      }

      // Print list
      function printList() {
        window.print();
      }

      // Show error
      function showError() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
      }

      // Helper functions
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        });
      }

      function getCategoryIcon(category) {
        const icons = {
          A√ßougue: 'ü•©',
          Padaria: 'üçû',
          Latic√≠nios: 'ü•õ',
          Bebidas: 'ü•§',
          'Cereais e Gr√£os': 'üåæ',
          Frutas: 'üçé',
          'Verduras e Legumes': 'ü•¨',
          Congelados: '‚ùÑÔ∏è',
          Higiene: 'üßº',
          Limpeza: 'üßΩ',
          Mercearia: 'üè™',
          'Doces e Sobremesas': 'üç∞',
          Outros: 'üì¶',
        };
        return icons[category] || 'üì¶';
      }

      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');

        let backgroundColor;
        switch (type) {
          case 'success':
            backgroundColor = 'var(--success-500)';
            break;
          case 'error':
            backgroundColor = 'var(--error-500)';
            break;
          case 'warning':
            backgroundColor = 'var(--warning-500)';
            break;
          default:
            backgroundColor = 'var(--primary-500)';
        }

        notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${backgroundColor};
                color: white;
                padding: var(--space-4) var(--space-6);
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
                font-weight: var(--font-medium);
            `;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 4000);
      }
    </script>
  </body>
</html>
