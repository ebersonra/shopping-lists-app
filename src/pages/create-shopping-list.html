<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Criar Lista de Compras - Bargainly Shopping</title>
    <link rel="icon" type="image/svg+xml" href="../../favicon.svg" />
    <link rel="stylesheet" href="../../static/css/style.css" />
    <link rel="stylesheet" href="../../static/css/create-shopping-list.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Header Navigation -->
    <header class="header-nav">
      <div class="nav-content">
        <a href="shopping-lists.html" class="back-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
          </svg>
          Voltar √†s Listas
        </a>
        <h1 class="header-title">Nova Lista de Compras</h1>
        <div class="save-indicator">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"
            />
          </svg>
          Salvamento autom√°tico
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
      <form class="create-form" id="createListForm">
        <div class="form-header">
          <h1 class="form-title">üõí Criar Nova Lista</h1>
          <p class="form-subtitle">Organize suas compras de forma inteligente</p>
        </div>

        <div class="success-message" id="successMessage">
          Lista criada com sucesso! Redirecionando...
        </div>

        <div class="form-body">
          <!-- Basic Information -->
          <section class="form-section">
            <h2 class="section-title">Informa√ß√µes B√°sicas</h2>
            <div class="form-grid">
              <div class="input-group">
                <label for="listTitle"> T√≠tulo da Lista <span class="required">*</span> </label>
                <input
                  type="text"
                  id="listTitle"
                  name="title"
                  placeholder="Ex: Lista do Supermercado"
                  required
                  maxlength="100"
                />
              </div>
              <div class="input-group">
                <label for="shoppingDate"> Data da Compra <span class="required">*</span> </label>
                <input type="date" id="shoppingDate" name="date" required />
              </div>
            </div>
            <div class="input-group">
              <label for="marketSelect">Mercado</label>
              <select id="marketSelect" name="market">
                <option value="">Selecione um mercado (opcional)</option>
              </select>
            </div>
            <div class="input-group">
              <label for="paymentSelect">Forma de Pagamento</label>
              <select id="paymentSelect" name="payment">
                <option value="">Selecione uma forma de pagamento (opcional)</option>
              </select>
            </div>
            <div class="input-group">
              <label for="listDescription">Descri√ß√£o</label>
              <textarea
                id="listDescription"
                name="description"
                placeholder="Descri√ß√£o opcional da lista..."
                maxlength="500"
              ></textarea>
            </div>
          </section>

          <!-- Items Section -->
          <section class="form-section">
            <h2 class="section-title">Itens da Lista</h2>
            <div class="items-section">
              <div class="items-header">
                <div class="items-counter"><span id="itemsCount">0</span> itens adicionados</div>
                <button type="button" class="add-item-btn" id="addItemBtn">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                  </svg>
                  Adicionar Item
                </button>
              </div>

              <div class="items-list" id="itemsList">
                <div class="empty-items">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path
                      d="M7 4V2C7 1.45 7.45 1 8 1H16C16.55 1 17 1.45 17 2V4H20C20.55 4 21 4.45 21 5S20.55 6 20 6H19V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V6H4C3.45 6 3 5.55 3 5S3.45 4 4 4H7Z"
                    />
                  </svg>
                  <p>Clique em "Adicionar Item" para come√ßar sua lista</p>
                </div>
              </div>
            </div>
          </section>

          <!-- Summary -->
          <section class="summary-section">
            <h3 class="summary-section-title">Resumo da Lista</h3>
            <div class="summary-grid">
              <div class="summary-item">
                <div class="summary-label">Total de Itens</div>
                <div class="summary-value" id="totalItems">0</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Categorias</div>
                <div class="summary-value" id="totalCategories">0</div>
              </div>
              <div class="summary-item">
                <div class="summary-label">Valor Total</div>
                <div class="summary-value total" id="totalValue">R$ 0,00</div>
              </div>
            </div>
          </section>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <a href="shopping-lists.html" class="btn-secondary">Cancelar</a>
          <button type="submit" class="btn-primary" id="saveListBtn">
            <span class="btn-text">Salvar Lista</span>
            <div class="loading">Salvando...</div>
          </button>
        </div>
      </form>
    </main>

    <!-- Payment Method Dialog -->
    <div id="paymentDialog" class="dialog-overlay" style="display: none;">
      <div class="dialog-content">
        <div class="dialog-header">
          <h2>Adicionar Forma de Pagamento</h2>
          <button type="button" class="dialog-close" onclick="closePaymentDialog()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        </div>
        <div class="dialog-body">
          <p>Voc√™ ainda n√£o tem nenhuma forma de pagamento cadastrada. Deseja adicionar uma agora?</p>
          <form id="paymentForm">
            <div class="input-group">
              <label for="paymentType">Tipo de Pagamento <span class="required">*</span></label>
              <select id="paymentType" name="type" required>
                <option value="">Selecione</option>
                <option value="credit">Cart√£o de Cr√©dito</option>
                <option value="debit">Cart√£o de D√©bito</option>
                <option value="pix">PIX</option>
              </select>
            </div>
            <div class="input-group">
              <label for="paymentDescription">Descri√ß√£o</label>
              <input 
                type="text" 
                id="paymentDescription" 
                name="description" 
                placeholder="Ex: Cart√£o Visa, Banco do Brasil..."
                maxlength="200"
              />
            </div>
            <div class="input-group">
              <label>
                <input type="checkbox" id="paymentDefault" name="is_default" />
                Definir como padr√£o
              </label>
            </div>
          </form>
        </div>
        <div class="dialog-actions">
          <button type="button" class="btn-secondary" onclick="closePaymentDialog()">Cancelar</button>
          <button type="button" class="btn-primary" onclick="savePaymentMethod()">Salvar</button>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let itemCounter = 0;
      let listItems = [];
      let currentUser = null;

      // UUID validation regex - shared constant
      const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

      // Categories for items
      const categories = [
        'A√ßougue',
        'Padaria',
        'Latic√≠nios',
        'Bebidas',
        'Cereais e Gr√£os',
        'Frutas',
        'Verduras e Legumes',
        'Congelados',
        'Higiene',
        'Limpeza',
        'Mercearia',
        'Doces e Sobremesas',
        'Outros',
      ];

      const units = [
        { value: 'un', label: 'Unidade' },
        { value: 'kg', label: 'Quilograma' },
        { value: 'g', label: 'Grama' },
        { value: 'l', label: 'Litro' },
        { value: 'ml', label: 'Mililitro' },
        { value: 'cx', label: 'Caixa' },
        { value: 'pct', label: 'Pacote' },
      ];

      // Get user ID from localStorage (matching other pages pattern)
      async function getUserId() {
        // Get user ID from localStorage (stored in currentUser after loadUserData)
        if (currentUser && currentUser.user_id) {
          return currentUser.user_id;
        }

        // Fallback: try to get from localStorage directly
        const userData = localStorage.getItem('bargainly_user');
        if (userData) {
          const user = JSON.parse(userData);
          if (user.user_id) {
            return user.user_id;
          }
        }

        console.error('Usu√°rio n√£o autenticado (user_id n√£o encontrado)');
        throw new Error('Usu√°rio n√£o autenticado');
      }

      // Initialize app
      document.addEventListener('DOMContentLoaded', function () {
        loadUserData();
        setupForm();
        populateMarkets();
        populatePaymentMethods();
        setupEventListeners();
      });

      // Load user data
      function loadUserData() {
        const userData = localStorage.getItem('bargainly_user');
        if (userData) {
          currentUser = JSON.parse(userData);

          // Migration: If user data doesn't have user_id, generate one and update localStorage
          if (!currentUser.user_id) {
            currentUser.user_id = generateUserId();
            localStorage.setItem('bargainly_user', JSON.stringify(currentUser));
          }
        } else {
          // Redirect to welcome page if no user data
          window.location.href = 'shopping-welcome.html';
        }
      }

      // Generate UUID for user identification
      function generateUserId() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
          const r = (Math.random() * 16) | 0;
          const v = c === 'x' ? r : (r & 0x3) | 0x8;
          return v.toString(16);
        });
      }

      // Setup form defaults
      function setupForm() {
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('shoppingDate').value = today;
      }

      // Load markets from API
      async function loadMarkets() {
        try {
          const user_id = await getUserId();

          const response = await fetch(`/.netlify/functions/get-markets?user_id=${user_id}`);

          if (!response.ok) {
            console.error('Failed to load markets:', response.status);
            return [];
          }

          const data = await response.json();
          return data.markets || [];
        } catch (error) {
          console.error('Error loading markets:', error);
          return [];
        }
      }

      // Load markets into select
      async function populateMarkets() {
        try {
          const markets = await loadMarkets();
          const select = document.getElementById('marketSelect');

          markets.forEach((market) => {
            const option = document.createElement('option');
            option.value = market.id;
            option.textContent = `${market.name}${market.address ? ' - ' + market.address : ''}`;
            select.appendChild(option);
          });
        } catch (error) {
          console.error('Error loading markets:', error);
        }
      }

      // Load payment methods from localStorage (simplified for now)
      // In a production app, this would fetch from an API
      async function loadPaymentMethods() {
        try {
          const user_id = await getUserId();

          const response = await fetch(`/.netlify/functions/get-payment-methods?user_id=${user_id}`);

          if (!response.ok) {
            console.error('Failed to load payment methods:', response.status);
            return [];
          }

          const data = await response.json();
          return data.paymentMethods || [];
        } catch (error) {
          console.error('Error loading payment methods:', error);
          return [];
        }
      }

      // Load payment methods into select
      async function populatePaymentMethods() {
        try {
          const paymentMethods = await loadPaymentMethods();
          const select = document.getElementById('paymentSelect');

          // Clear existing options except the first one
          while (select.options.length > 1) {
            select.remove(1);
          }

          if (paymentMethods.length === 0) {
            // No payment methods found - show dialog to create one
            console.log('No payment methods found for user');
            // The user can still create a list without a payment method
            return;
          }

          paymentMethods.forEach((payment) => {
            const option = document.createElement('option');
            option.value = payment.id;
            const defaultLabel = payment.is_default ? ' (Padr√£o)' : '';
            option.textContent = `${payment.description || payment.type}${defaultLabel}`;
            select.appendChild(option);
          });
        } catch (error) {
          console.error('Error loading payment methods:', error);
        }
      }

      // Setup event listeners
      function setupEventListeners() {
        document.getElementById('addItemBtn').addEventListener('click', addItemForm);
        document.getElementById('createListForm').addEventListener('submit', saveList);
      }

      // Add new item form
      function addItemForm() {
        itemCounter++;
        const itemForm = createItemFormHTML(itemCounter);

        // Remove empty state if this is the first item
        const emptyState = document.querySelector('.empty-items');
        if (emptyState) {
          emptyState.remove();
        }

        document.getElementById('itemsList').insertAdjacentHTML('beforeend', itemForm);
        setupItemFormEvents(itemCounter);
        updateSummary();
      }

      // Create item form HTML
      function createItemFormHTML(id) {
        return `
                <div class="item-form" data-item-id="${id}">
                    <button type="button" class="remove-item-btn" onclick="removeItem(${id})">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                    
                    <div class="item-form-grid">
                        <div class="input-group">
                            <label for="itemName${id}">Nome do Produto</label>
                            <input 
                                type="text" 
                                id="itemName${id}" 
                                name="itemName${id}"
                                placeholder="Ex: Arroz Branco 5kg"
                                required
                                data-field="name"
                            >
                        </div>
                        
                        <div class="input-group">
                            <label for="itemCategory${id}">Categoria</label>
                            <select 
                                id="itemCategory${id}" 
                                name="itemCategory${id}"
                                required
                                data-field="category"
                            >
                                <option value="">Selecione</option>
                                ${categories.map((cat) => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label for="itemQuantity${id}">Quantidade</label>
                            <input 
                                type="number" 
                                id="itemQuantity${id}" 
                                name="itemQuantity${id}"
                                step="0.001"
                                min="0"
                                value="1"
                                required
                                data-field="quantity"
                            >
                        </div>
                        
                        <div class="input-group">
                            <label for="itemUnit${id}">Unidade</label>
                            <select 
                                id="itemUnit${id}" 
                                name="itemUnit${id}"
                                required
                                data-field="unit"
                            >
                                ${units.map((unit) => `<option value="${unit.value}" ${unit.value === 'un' ? 'selected' : ''}>${unit.label}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label for="itemPrice${id}">Pre√ßo Unit.</label>
                            <input 
                                type="number" 
                                id="itemPrice${id}" 
                                name="itemPrice${id}"
                                step="0.01"
                                min="0"
                                placeholder="0,00"
                                data-field="price"
                            >
                        </div>
                        
                        <div class="item-total" id="itemTotal${id}">
                            R$ 0,00
                        </div>
                    </div>
                </div>
            `;
      }

      // Setup events for item form
      function setupItemFormEvents(id) {
        const form = document.querySelector(`[data-item-id="${id}"]`);
        const inputs = form.querySelectorAll('input, select');

        inputs.forEach((input) => {
          input.addEventListener('input', () => updateItemTotal(id));
          input.addEventListener('change', () => updateItemTotal(id));
        });
      }

      // Update item total
      function updateItemTotal(id) {
        const quantity = parseFloat(document.getElementById(`itemQuantity${id}`).value) || 0;
        const price = parseFloat(document.getElementById(`itemPrice${id}`).value) || 0;
        const total = quantity * price;

        document.getElementById(`itemTotal${id}`).textContent = `R$ ${total.toFixed(2)}`;
        updateSummary();
      }

      // Remove item
      function removeItem(id) {
        const itemForm = document.querySelector(`[data-item-id="${id}"]`);
        if (itemForm) {
          itemForm.remove();

          // Show empty state if no items left
          const remainingItems = document.querySelectorAll('.item-form');
          if (remainingItems.length === 0) {
            document.getElementById('itemsList').innerHTML = `
                        <div class="empty-items">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7 4V2C7 1.45 7.45 1 8 1H16C16.55 1 17 1.45 17 2V4H20C20.55 4 21 4.45 21 5S20.55 6 20 6H19V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V6H4C3.45 6 3 5.55 3 5S3.45 4 4 4H7Z"/>
                            </svg>
                            <p>Clique em "Adicionar Item" para come√ßar sua lista</p>
                        </div>
                    `;
          }

          updateSummary();
        }
      }

      // Update summary
      function updateSummary() {
        const itemForms = document.querySelectorAll('.item-form');
        let totalItems = itemForms.length;
        let totalValue = 0;
        let categories = new Set();

        itemForms.forEach((form) => {
          const id = form.getAttribute('data-item-id');
          const quantity = parseFloat(document.getElementById(`itemQuantity${id}`).value) || 0;
          const price = parseFloat(document.getElementById(`itemPrice${id}`).value) || 0;
          const category = document.getElementById(`itemCategory${id}`).value;

          totalValue += quantity * price;
          if (category) categories.add(category);
        });

        document.getElementById('itemsCount').textContent = totalItems;
        document.getElementById('totalItems').textContent = totalItems;
        document.getElementById('totalCategories').textContent = categories.size;
        document.getElementById('totalValue').textContent = `R$ ${totalValue.toFixed(2)}`;
      }

      // Collect form data
      function collectFormData() {
        // Get payment select value - only use if it's a valid UUID format
        const paymentSelectValue = document.getElementById('paymentSelect').value;
        const paymentId = paymentSelectValue && UUID_REGEX.test(paymentSelectValue) ? paymentSelectValue : null;

        const formData = {
          title: document.getElementById('listTitle').value.trim(),
          description: document.getElementById('listDescription').value.trim(),
          shoppingDate: document.getElementById('shoppingDate').value,
          marketId: document.getElementById('marketSelect').value || null,
          paymentId: paymentId,
          items: [],
        };

        const itemForms = document.querySelectorAll('.item-form');
        itemForms.forEach((form) => {
          const id = form.getAttribute('data-item-id');
          const item = {
            product_name: document.getElementById(`itemName${id}`).value.trim(),
            category: document.getElementById(`itemCategory${id}`).value,
            quantity: parseFloat(document.getElementById(`itemQuantity${id}`).value) || 0,
            unit: document.getElementById(`itemUnit${id}`).value,
            unit_price: parseFloat(document.getElementById(`itemPrice${id}`).value) || 0,
          };

          if (item.product_name && item.category) {
            item.total_price = item.quantity * item.unit_price;
            formData.items.push(item);
          }
        });

        return formData;
      }

      // Save list
      async function saveList(e) {
        e.preventDefault();

        const formData = collectFormData();

        // Validation
        if (!formData.title) {
          alert('Por favor, digite um t√≠tulo para a lista');
          return;
        }

        if (formData.items.length === 0) {
          alert('Adicione pelo menos um item √† lista');
          return;
        }

        const saveBtn = document.getElementById('saveListBtn');
        const btnText = saveBtn.querySelector('.btn-text');
        const loading = saveBtn.querySelector('.loading');

        // Show loading state
        saveBtn.disabled = true;
        btnText.style.display = 'none';
        loading.style.display = 'flex';

        try {
          // Get user ID
          const user_id = await getUserId();

          // Prepare data for API call
          const requestData = {
            user_id: user_id,
            title: formData.title,
            description: formData.description,
            shopping_date: formData.shoppingDate,
            market_id: formData.marketId,
            payment_id: formData.paymentId,
            items: formData.items,
          };

          // Call API to create shopping list
          const response = await fetch('/.netlify/functions/create-shopping-list', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Erro ao salvar lista');
          }

          const result = await response.json();
          console.log('Lista criada com sucesso:', result);

          // Show success message
          document.getElementById('successMessage').style.display = 'block';

          // Clear draft from localStorage
          localStorage.removeItem('bargainly_draft_list');

          // Redirect after success
          setTimeout(() => {
            window.location.href = 'shopping-lists.html';
          }, 1500);
        } catch (error) {
          console.error('Error saving list:', error);
          alert(`Erro ao salvar lista: ${error.message}`);

          // Reset button state
          saveBtn.disabled = false;
          btnText.style.display = 'inline';
          loading.style.display = 'none';
        }
      }

      // Auto-save functionality (placeholder)
      let autoSaveTimeout;
      function autoSave() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
          // Save to localStorage as draft
          const formData = collectFormData();
          if (formData.title || formData.items.length > 0) {
            localStorage.setItem('bargainly_draft_list', JSON.stringify(formData));
          }
        }, 2000);
      }

      // Load draft on page load
      function loadDraft() {
        const draft = localStorage.getItem('bargainly_draft_list');
        if (draft) {
          const data = JSON.parse(draft);
          // Implementation to restore form data
          console.log('Draft found:', data);
        }
      }

      // Payment Dialog Functions
      function showPaymentDialog() {
        document.getElementById('paymentDialog').style.display = 'flex';
      }

      function closePaymentDialog() {
        document.getElementById('paymentDialog').style.display = 'none';
        document.getElementById('paymentForm').reset();
      }

      async function savePaymentMethod() {
        const form = document.getElementById('paymentForm');
        const type = document.getElementById('paymentType').value;
        const description = document.getElementById('paymentDescription').value.trim();
        const is_default = document.getElementById('paymentDefault').checked;

        if (!type) {
          alert('Por favor, selecione o tipo de pagamento');
          return;
        }

        try {
          const user_id = await getUserId();

          const response = await fetch('/.netlify/functions/create-payment-method', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              user_id,
              type,
              description: description || null,
              is_default,
              enabled: true,
            }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Erro ao salvar forma de pagamento');
          }

          const result = await response.json();
          console.log('Payment method created:', result);

          // Close dialog
          closePaymentDialog();

          // Reload payment methods
          await populatePaymentMethods();

          // Show success message
          alert('Forma de pagamento adicionada com sucesso!');
        } catch (error) {
          console.error('Error saving payment method:', error);
          alert(`Erro ao salvar forma de pagamento: ${error.message}`);
        }
      }

      // Add button to open payment dialog next to payment select
      function addCreatePaymentButton() {
        const paymentSelectGroup = document.getElementById('paymentSelect').parentElement;
        
        // Create button container
        const buttonContainer = document.createElement('div');
        buttonContainer.style.marginTop = '8px';
        
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'btn-secondary';
        button.style.fontSize = '14px';
        button.style.padding = '8px 16px';
        button.textContent = '+ Adicionar Forma de Pagamento';
        button.onclick = showPaymentDialog;
        
        buttonContainer.appendChild(button);
        paymentSelectGroup.appendChild(buttonContainer);
      }

      // Call this after page loads
      document.addEventListener('DOMContentLoaded', function() {
        addCreatePaymentButton();
      });
    </script>
  </body>
</html>
