<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Welcome - Bargainly Shopping</title>
    <link rel="icon" type="image/svg+xml" href="../../favicon.svg" />
    <link rel="stylesheet" href="../../static/css/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="shopping-welcome-container">
      <!-- Floating particles -->
      <div class="shopping-floating-particles" id="particles">
        <div class="shopping-particle"></div>
        <div class="shopping-particle"></div>
        <div class="shopping-particle"></div>
        <div class="shopping-particle"></div>
        <div class="shopping-particle"></div>
        <div class="shopping-particle"></div>
        <div class="shopping-particle"></div>
        <div class="shopping-particle"></div>
        <div class="shopping-particle"></div>
      </div>

      <div class="shopping-welcome-card">
        <div class="shopping-welcome-header">
          <div class="shopping-welcome-logo">
            <img src="../../static/images/logo.svg" alt="Shopping Lists Logo" />
          </div>
          <h1 class="shopping-welcome-title">Shopping Lists</h1>
          <p class="shopping-welcome-subtitle">Suas listas de compras inteligentes</p>
        </div>

        <div class="shopping-welcome-description">
          <h3>üõí Organize suas compras como nunca antes!</h3>
          <p>
            Crie listas de compras personalizadas, compartilhe com familiares e economize tempo e
            dinheiro.
          </p>

          <ul class="shopping-benefits-list">
            <li>Listas organizadas por categoria e pre√ßo</li>
            <li>Compartilhamento f√°cil via c√≥digo</li>
            <li>Controle de gastos por mercado</li>
            <li>Interface intuitiva e responsiva</li>
          </ul>
        </div>

        <form class="shopping-welcome-form" id="welcomeForm">
          <div class="shopping-form-section">
            <h3 class="shopping-form-section-title">
              <svg class="shopping-form-section-icon" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1L9 7V9H21ZM12 8C10.9 8 10 8.9 10 10S10.9 12 12 12 14 11.1 14 10 13.1 8 12 8Z"
                />
              </svg>
              Dados Pessoais
            </h3>

            <div class="shopping-form-grid">
              <div class="shopping-form-group">
                <label class="shopping-form-label" for="userName">Nome completo</label>
                <input
                  class="shopping-form-input"
                  type="text"
                  id="userName"
                  name="userName"
                  placeholder="Digite seu nome completo"
                />
              </div>

              <div class="shopping-form-group">
                <label class="shopping-form-label" for="userPhone">Telefone (WhatsApp)</label>
                <input
                  class="shopping-form-input"
                  type="tel"
                  id="userPhone"
                  name="userPhone"
                  placeholder="(11) 99999-9999"
                />
              </div>
            </div>
          </div>

          <div class="shopping-form-section">
            <h3 class="shopping-form-section-title">
              <svg class="shopping-form-section-icon" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M12 2L15.09 8.26L22 9L17 14L18.18 21L12 17.77L5.82 21L7 14L2 9L8.91 8.26L12 2Z"
                />
              </svg>
              Mercado Preferido
            </h3>

            <div class="shopping-form-group">
              <label class="shopping-form-label" for="preferredMarket">Escolha seu mercado</label>
              <div class="shopping-select-wrapper">
                <select class="shopping-form-select" id="preferredMarket" name="preferredMarket">
                  <option value="">Selecione um mercado</option>
                  <option value="carrefour">Carrefour</option>
                  <option value="pao-de-acucar">P√£o de A√ß√∫car</option>
                  <option value="extra">Extra</option>
                  <option value="walmart">Walmart</option>
                  <option value="atacadao">Atacad√£o</option>
                  <option value="assai">Assa√≠</option>
                  <option value="outros">Outros</option>
                </select>
              </div>
              <div class="shopping-market-info" id="marketInfo">
                <h4>üí° Dica inteligente</h4>
                <p>
                  Escolher um mercado ajuda a personalizar suas listas com produtos e pre√ßos
                  espec√≠ficos da rede!
                </p>
              </div>
            </div>
          </div>

          <div class="shopping-welcome-actions">
            <button
              type="submit"
              class="btn btn-primary btn-large"
              style="
                background: #0284c7;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                border: none;
                display: flex;
                align-items: center;
                gap: 8px;
              "
            >
              <span>Come√ßar Agora</span>
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                style="width: 20px; height: 20px"
              >
                <path d="M5 12h14M12 5l7 7-7 7" />
              </svg>
            </button>
            <button
              type="button"
              class="btn btn-secondary btn-large"
              id="skipBtn"
              style="
                background: #6b7280;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                border: none;
              "
            >
              Pular por Agora
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Environment variables (injected at build time) -->
    <script src="/src/utils/env.js"></script>

    <!-- Configuration (must be loaded after env.js) -->
    <script src="/src/utils/config.js"></script>

    <!-- Supabase Utilities -->
    <script src="/src/utils/supabaseClient.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('welcomeForm');
        const skipBtn = document.getElementById('skipBtn');
        const marketSelect = document.getElementById('preferredMarket');
        const marketInfo = document.getElementById('marketInfo');
        const phoneInput = document.getElementById('userPhone');

        // Initialize Supabase
        console.log('üöÄ Initializing Supabase...');
        SupabaseUtils.initSupabase();

        // M√°scara de telefone
        phoneInput.addEventListener('input', function (e) {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length >= 11) {
            value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
          } else if (value.length >= 7) {
            value = value.replace(/^(\d{2})(\d{4})(\d+)/, '($1) $2-$3');
          } else if (value.length >= 3) {
            value = value.replace(/^(\d{2})(\d+)/, '($1) $2');
          } else if (value.length >= 1) {
            value = value.replace(/^(\d+)/, '($1');
          }
          e.target.value = value;
        });

        // Mostrar informa√ß√µes do mercado
        marketSelect.addEventListener('change', function () {
          if (this.value) {
            marketInfo.classList.add('show');
          } else {
            marketInfo.classList.remove('show');
          }
        });

        // Fun√ß√£o para gerar dados aleat√≥rios
        function generateRandomName() {
          const names = [
            'Ana Silva',
            'Jo√£o Santos',
            'Maria Oliveira',
            'Pedro Costa',
            'Lucas Pereira',
          ];
          return names[Math.floor(Math.random() * names.length)];
        }

        function generateRandomPhone() {
          const prefix = '11';
          const number = Math.floor(Math.random() * 900000000) + 100000000;
          return `(${prefix}) 9${number.toString().substring(0, 4)}-${number.toString().substring(4)}`;
        }

        /**
         * Process user data and redirect to main page
         * Gets or creates user in Supabase database
         */
        async function processAndRedirect(name, phone, skipped = false) {
          try {
            console.log('üìù Processing user data...');

            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>Processando...</span>';
            skipBtn.disabled = true;

            // Prepare user data
            const cleanPhone = phone.replace(/\D/g, '');

            // Get or create user in database
            const user = await SupabaseUtils.getOrCreateUser({
              name: name,
              phone: cleanPhone,
              email: null,
              preferred_market_id: null, // Will be set after market creation
              skipped_onboarding: skipped,
            });

            if (!user) {
              throw new Error('Failed to create or retrieve user');
            }

            console.log('‚úÖ User retrieved/created:', user);

            // Handle preferred market
            let marketId = null;
            const selectedMarket = marketSelect.value;

            if (selectedMarket && selectedMarket !== '') {
              console.log('üè™ Processing preferred market:', selectedMarket);
              marketId = await SupabaseUtils.findOrCreateMarket(selectedMarket, user.id);

              if (marketId) {
                // Update user with preferred market
                await SupabaseUtils.updateUser(user.id, {
                  preferred_market_id: marketId,
                });
                console.log('‚úÖ User updated with preferred market');
              }
            }

            // Prepare data for localStorage (for quick access on other pages)
            const userData = {
              user_id: user.id,
              name: user.name || name,
              phone: cleanPhone,
              email: user.email,
              preferred_market_id: marketId,
              preferred_market_name: selectedMarket,
              skipped_onboarding: skipped,
              timestamp: new Date().toISOString(),
            };

            // Save to localStorage
            localStorage.setItem('bargainly_user', JSON.stringify(userData));
            console.log('üíæ User data saved to localStorage');

            // Show success message
            submitBtn.innerHTML = '<span>‚úÖ Sucesso! Redirecionando...</span>';

            // Redirect to main page
            setTimeout(() => {
              window.location.href = 'shopping-lists.html';
            }, 500);
          } catch (error) {
            console.error('‚ùå Error processing user:', error);

            // Show error message
            alert('Ocorreu um erro ao processar seus dados. Tente novamente.');

            // Reset button state
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
            skipBtn.disabled = false;
          }
        }

        // Envio do formul√°rio
        form.addEventListener('submit', async function (e) {
          e.preventDefault();
          console.log('üìã Form submitted');

          const userName = document.getElementById('userName').value.trim() || generateRandomName();
          const userPhone =
            document.getElementById('userPhone').value.trim() || generateRandomPhone();

          console.log('üë§ Name:', userName, 'üì± Phone:', userPhone);

          await processAndRedirect(userName, userPhone, false);
        });

        // Bot√£o de pular
        skipBtn.addEventListener('click', async function (e) {
          e.preventDefault();
          console.log('‚è≠Ô∏è Skip button clicked');

          const name = generateRandomName();
          const phone = generateRandomPhone();

          await processAndRedirect(name, phone, true);
        });
      });
    </script>
  </body>
</html>
